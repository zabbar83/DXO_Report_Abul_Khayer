SELECT DISTINCT pur.target_date                          AS targetDate,
                vta.wing_id                              AS wingId,
                vta.wing_name                            AS wingName,
                vta.division_id                          AS divisionId,
                vta.division_name                        AS divisionName,
                vta.teritory_id                          AS teritoryId,
                vta.teritory_name                        AS teritoryName,
                dxo.user_id                                 dxoId,
                dxo.user_name                               dxoName,
                bt.bruser_id                             AS adxoId,
                br.name                                  AS adxoName,
                br.CONTACT_NUMBER                        AS adxoContactNo,
                bc.CUSTOMER_NAME                         AS consumerName,
                bc.AGE                                   AS consumerAge,
                bct.CONTACT_NUMBER                       AS consumerNumber,
                pur.DAILY_STICK_CONSUMPTION              AS dailyStickConsumption,
                cwa.relation                             AS earner,
                pce_cwe.PROGRAM                          AS cweEducation,
                pcp_cwe.profession                       AS cweProfession,
                pce_res.program                          AS resEducation,
                pcp_res.profession                       AS resProfession,
                dp_prev.name                             AS previousBrand,
                dp_now.name                              AS presentBrand,
                ocb.occasional_brand                     AS occasionalBrand,
                bc.ID                                    AS brActConsumerId,
                to_char(pur.add_date_time, 'HH12:MI AM') as activityTime,
                nc.knownBrand

FROM appdxo.product_usage_record pur
         JOIN appdxo.bractivity_consumer bc ON bc.id = pur.PROD_CONSUMER_ID
         AND    bc.id not in (select  distinct br_activity_consumer_id
                            from    CC_CONS_FIRST_ANSWERS ccfa
                            where   activity_date = :targetDate
                          )
         JOIN appdxo.bractivity_contact bct ON bc.BR_ACTIVITY_CONTACT_ID = bct.id
         JOIN appdxo.bruser_teritory bt ON bt.bruser_id = pur.added_by AND SYSDATE BETWEEN bt.ed AND bt.td
         JOIN appdxo.bruser bu on bt.bruser_id = bu.user_id
         JOIN (select user_id, user_name, teritory_id
               from users u
                        join users_roles ur on u.user_id = ur.users_user_id
                   and ur.roles_id = 7) dxo on bu.teritory_id = dxo.teritory_id
         JOIN appdxo.v_teritory_all vta ON vta.teritory_id = bt.teritory_id
    AND (vta.teritory_id = :territoryId or vta.division_id = :territoryId)
         JOIN appdxo.brand_representative br ON br.br_user_user_id = bt.bruser_id
         LEFT JOIN appdxo.br_activity_cons_info baci ON pur.PROD_CONSUMER_ID = baci.BR_ACTIVITY_CONSUMER_ID
         LEFT JOIN appdxo.chief_wage_earner cwa ON cwa.id = baci.earner_id
         LEFT JOIN appdxo.product_consumer_edu pce_cwe ON pce_cwe.id = baci.cwe_education_id
         LEFT JOIN appdxo.product_consumer_edu pce_res ON pce_res.id = baci.RES_EDUCATION_ID
         LEFT JOIN appdxo.product_consumer_prof pcp_cwe ON pcp_cwe.id = baci.CWE_PROFESSION_ID
         LEFT JOIN appdxo.product_consumer_prof pcp_res ON pcp_res.id = baci.res_PROFESSION_ID
         LEFT JOIN appdxo.product_cons_before pcb ON pcb.PROD_USE_REC_ID = pur.ID
         LEFT JOIN appdxo.product_cons_now pcn ON pcn.PROD_USE_REC_ID = pur.ID
         LEFT JOIN appdxo.dxo_product dp_prev ON dp_prev.id = pcb.PREV_PROD_ID
         LEFT JOIN appdxo.dxo_product dp_now ON dp_now.id = pcn.PRESENT_PRODUCT_ID
         LEFT JOIN (SELECT pur.PROD_CONSUMER_ID,
                           LISTAGG(dp.name, ', ') WITHIN GROUP (ORDER BY dp.name) AS occasional_brand
                    FROM appdxo.product_usage_record pur
                             LEFT JOIN appdxo.product_cons_occ pco ON pur.ID = pco.PROD_USE_REC_ID
                             LEFT JOIN appdxo.dxo_product dp ON dp.id = pco.OCCASIONAL_PROD_ID
                    WHERE pur.target_date = :targetDate 
                    GROUP BY pur.PROD_CONSUMER_ID) ocb ON pur.PROD_CONSUMER_ID = ocb.PROD_CONSUMER_ID
         LEFT JOIN (SELECT PROD_CONSUMER_ID,
                           listagg(brand, ', ') within group (order by PROD_CONSUMER_ID) knownBrand
                    FROM (SELECT pur.PROD_CONSUMER_ID,
                                 dp.name AS brand,
                                 ncr.reason,
                                 pncr.REMARKS,
                                 ROW_NUMBER() OVER (
                                     PARTITION BY pur.PROD_CONSUMER_ID
                                     ORDER BY dp.name
                                     )   AS rn
                          FROM appdxo.product_usage_record pur
                                   LEFT JOIN appdxo.product_non_cons_reasons pncr ON pncr.PROD_USE_REC_ID = pur.id
                                   LEFT JOIN appdxo.not_con_reasons ncr ON ncr.ID = pncr.NOT_CONS_REASON_ID
                                   LEFT JOIN appdxo.dxo_product dp ON dp.id = pncr.OCCASIONAL_PROD_ID
                          WHERE pur.target_date = :targetDate )
                    GROUP BY PROD_CONSUMER_ID) nc ON pur.PROD_CONSUMER_ID = nc.PROD_CONSUMER_ID
WHERE pur.target_date = :targetDate