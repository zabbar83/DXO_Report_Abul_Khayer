SELECT DISTINCT pd.target_date                           AS surveyDate, 
                     
                                    vta.wing_id                              AS wingId, 
                                    vta.wing_name                            AS wingName, 
                                    vta.division_id                          AS divisionId, 
                                    vta.division_name                        AS divisionName, 
                                    vta.teritory_id                          AS territoryId, 
                                    vta.teritory_name                        AS territoryName, 
                                    vta.zone_id                              AS zoneId, 
                                    vta.zone_name                            AS zoneName, 
                                    vta.route_id                             AS routeId, 
                                    vta.route_name                           AS routeName, 
                                    ab.address_line1                         AS clusterName, 
                     
                                    pd.br_user_id                            AS brUserId, 
                                    br.name                                  AS brName, 
                                    br.contact_number                        AS brContactNumber, 
                     
                                    c.id                                     AS consumerId, 
                                    c.consumer_code                          AS consumerCode, 
                                    c.trade_license_name                     AS tradeLicenseName, 
                                    NVL(c.mobile_no,'N/A')                             AS consumerMobileNo, 
                                    c.lat                                    AS latitude, 
                                    c.lng                                    AS longitude, 
                     
                                    qn.channel_type                          AS channelType, 
                                    qn.frequency                             AS frequency, 
                                    qn.pposm                                 AS pposm, 
                                    qn.is_astha                              AS isAstha, 
                                    qn.achiever                              AS achiever, 
                                    qn.astha_gift                            AS asthaGift, 
                                    qn.memo_company                          AS memoCompany, 
                                    qn.sell_product                          AS sellProduct, 
                     
                                    qp.market_products                       AS inputProducts, 
                     
                                    TO_CHAR(c1.cross_check_time, 'HH.MI AM') AS crossTime 
                     
                    FROM appdxo.v_teritory_all vta 
                     
                             JOIN appdxo.consumer_teritory ct 
                                  ON ct.teritory_id = vta.route_id 
                                      AND (vta.teritory_id = :territoryId 
                                          OR vta.division_id = :territoryId) 
                     
                             JOIN CC_OUT_ANSWERS c1 
                                  ON ct.consumer_id = c1.outlet_id 
                                      AND c1.cross_check_date = :targetDate 
                     
                             JOIN appdxo.consumer c 
                                  ON c.id = ct.consumer_id 
                     
                             JOIN appdxo.consumer_address ca 
                                  ON ca.consumer_id = c.id 
                     
                             JOIN appdxo.address_book ab 
                                  ON ab.id = ca.address_id 
                     
                             JOIN appdxo.product_record pd 
                                  ON pd.consumer_id = c.id 
                                      --AND pd.target_date = :targetDate 
                     
                             JOIN appdxo.BRAND_REPRESENTATIVE br 
                                  ON pd.br_user_id = br.BR_USER_USER_ID 
                     
                             JOIN (SELECT consumer_id, 
                                          MAX(CASE WHEN question_id = 1 THEN ans END)  AS channel_type, 
                                          MAX(CASE WHEN question_id = 3 THEN ans END)  AS frequency, 
                                          MAX(CASE WHEN question_id = 4 THEN ans END)  AS pposm, 
                                          MAX(CASE WHEN question_id = 6 THEN ans END)  AS is_astha, 
                                          MAX(CASE WHEN question_id = 7 THEN ans END)  AS achiever, 
                                          MAX(CASE WHEN question_id = 8 THEN ans END)  AS astha_gift, 
                                          MAX(CASE WHEN question_id = 10 THEN ans END) AS memo_company, 
                                          MAX(CASE WHEN question_id = 12 THEN ans END) AS sell_product 
                                   FROM (SELECT qa.consumer_id, 
                                                qa.question_id, 
                                                LISTAGG(qao.question_option, ', ') 
                                                        WITHIN GROUP (ORDER BY qa.consumer_id, qa.question_id) AS ans 
                                         FROM appdxo.question_answers qa 
                                                  JOIN appdxo.question_opts_map qom 
                                                       ON qom.id = qa.question_option_map_id 
                                                  JOIN appdxo.ques_activity_opts qao 
                                                       ON qao.id = qom.question_options_id 
                                         --WHERE qa.target_date = :targetDate 
                                         GROUP BY qa.consumer_id, qa.question_id) 
                                   GROUP BY consumer_id) qn 
                                  ON qn.consumer_id = c.id 
                     
                             LEFT JOIN (SELECT consumer_id, 
                                               LISTAGG(product_name, ', ') 
                                                       WITHIN GROUP (ORDER BY ques_market_product_id) AS market_products 
                                        FROM (SELECT DISTINCT pr.consumer_id, 
                                                              qmp.product_name, 
                                                              pr.ques_market_product_id 
                                              FROM product_record pr 
                                                       JOIN ques_market_product qmp 
                                                            ON pr.ques_market_product_id = qmp.id 
                                              --WHERE pr.target_date = :targetDate
                                              ) 
                                        GROUP BY consumer_id) qp 
                                       ON qp.consumer_id = c.id