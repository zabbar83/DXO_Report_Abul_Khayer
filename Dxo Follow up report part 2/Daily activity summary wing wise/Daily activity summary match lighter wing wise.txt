select  lig.wing_id wingId,
        lig.wing_name wingName,
        NVL(lig.ligOutlet, 0) AS ligOutlet, 
        NVL(lig.ligSellingOut, 0) AS ligSellingOut,
        NVL(lig.stockAvailOutlet, 0) AS stockAvailOutlet,
        NVL(lig.ligAvailable, 0) AS ligAvailable,
        
        NVL(mat.matchOutlet, 0) AS matchOutlet,
        NVL(mat.matchSellingOut, 0) AS matchSellingOut,
        NVL(mat.maStockAvaOutlet, 0) AS maStockAvaOutlet,
        NVL(mat.matchAvailable, 0) AS matchAvailable

from
(select  
        v.wing_id,
        v.wing_name,
        abd.ligOutlet,
        abd.ligSellingOut,
        abd.stockAvailOutlet,
        abd.ligAvailable
from (select distinct wing_id,wing_name from v_teritory_all v where 1=1 and (:wingId is null or v.wing_id = :wingId))v
Left    Join
(select  
        v.wing_id wingId,v.wing_name wingName,
        count(distinct case when qmp.id in (54,55,101) then pr.consumer_id else null end)ligOutlet,
        count(distinct case when qmp.id in (54,55,101) then qa.consumer_id else null end) ligSellingOut,
        count(distinct case when qmp.id in (54,55,101) and pr.product_stock > 0 then pr.consumer_id else null end) stockAvailOutlet,
        round(case when count(distinct case when qmp.id in (54,55,101) then qa.consumer_id else null end) > 0 then (count(distinct case when qmp.id in (54,55,101) and pr.product_stock > 0 then pr.consumer_id else null end) * 100) /count(distinct case when qmp.id in (54,55,101) then qa.consumer_id else null end) else 0 end) ligAvailable
from    (select * from v_teritory_all v where 1=1 and (:wingId is null or v.wing_id = :wingId)) v
join    consumer_teritory ct on ct.teritory_id=v.route_id
join    consumer c on ct.consumer_id=c.id and c.status=1
join    product_record pr on c.id=pr.consumer_id
and     pr.target_date= :targetDate
join    ques_market_product qmp on pr.QUES_MARKET_PRODUCT_ID=qmp.id
left    join (select  distinct qao.id slim_cig_ans_id,q.consumer_id
            from    question_answers q
            join    product_record pr on q.consumer_id=pr.consumer_id
            and     pr.target_date= :targetDate
            join    question_opts_map qom on q.QUESTION_OPTION_MAP_ID=qom.id and q.question_id=12
            join    ques_activity_opts qao on qom.question_options_id=qao.id and qao.id=26
        )qa on pr.consumer_id=qa.consumer_id
left    join own_market_product_map ompm on qmp.id=ompm.market_product_id
left    join territory_products tp on ompm.own_product_id=tp.product_id
group   by v.wing_id,v.wing_name)abd
on v.wing_id=abd.wingId
)lig
JOIN

(select  
        v.wing_id,
        v.wing_name,
        abd.matchOutlet,
        abd.matchSellingOut,
        abd.maStockAvaOutlet,
        abd.matchAvailable
from (select distinct wing_id,wing_name from v_teritory_all v where 1=1 and (:wingId is null or v.wing_id = :wingId)) v
Left    Join
(select  
        v.wing_id wingId,v.wing_name wingName,
        count(distinct case when qmp.id in (48,49) then pr.consumer_id else null end)matchOutlet,
        count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) matchSellingOut,
        count(distinct case when qmp.id in (48,49) and pr.product_stock > 0 then pr.consumer_id else null end) maStockAvaOutlet,
        round(case when count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) > 0 then (count(distinct case when qmp.id in (48,49) and pr.product_stock > 0 then pr.consumer_id else null end) * 100) /count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) else 0 end) matchAvailable
from    (select * from v_teritory_all v where 1=1 and (:wingId is null or v.wing_id = :wingId)) v
join    consumer_teritory ct on ct.teritory_id=v.route_id
join    consumer c on ct.consumer_id=c.id and c.status=1
join    product_record pr on c.id=pr.consumer_id
and     pr.target_date= :targetDate
join    ques_market_product qmp on pr.QUES_MARKET_PRODUCT_ID=qmp.id
left    join (select  distinct qao.id slim_cig_ans_id,q.consumer_id
            from    question_answers q
            join    product_record pr on q.consumer_id=pr.consumer_id
            and     pr.target_date= :targetDate
            join    question_opts_map qom on q.QUESTION_OPTION_MAP_ID=qom.id and q.question_id=12
            join    ques_activity_opts qao on qom.question_options_id=qao.id and qao.id=25
        )qa on pr.consumer_id=qa.consumer_id
left    join own_market_product_map ompm on qmp.id=ompm.market_product_id
left    join territory_products tp on ompm.own_product_id=tp.product_id
group   by v.wing_id,v.wing_name)abd
on v.wing_id=abd.wingId
)mat ON lig.wing_id=mat.wing_id
order by lig.wing_id