select  teritory_id teritoryId,
        teritory_name teritoryName,
        matchAvailable,
        matchAvailable2     
from
(select  
        abd.teritory_id,
        abd.teritory_name,
        abd.matchOutlet,
        abd.matchSellingOut,
        abd.maStockAvaOutlet,
        abd.matchAvailable,
        
        apd.matchOutlet2,
        apd.matchSellingOut2,
        apd.maStockAvaOutlet2,
        apd.matchAvailable2
from
(select  *
from (select distinct teritory_id,teritory_name from v_teritory_all v where 1=1 and (:wingId is null or v.wing_id = :wingId)) v
Left    Join
(select  
        v.teritory_id teritoryId,v.teritory_name teritoryName,
        count(distinct case when qmp.id in (48,49) then pr.consumer_id else null end)matchOutlet,
        count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) matchSellingOut,
        count(distinct case when qmp.id in (48,49) and pr.product_stock > 0 then pr.consumer_id else null end) maStockAvaOutlet,
        round(case when count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) > 0 then (count(distinct case when qmp.id in (48,49) and pr.product_stock > 0 then pr.consumer_id else null end) * 100) /count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) else 0 end) matchAvailable
from    (select * from v_teritory_all v where 1=1 and (:wingId is null or v.wing_id = :wingId)) v
join    consumer_teritory ct on ct.teritory_id=v.route_id
join    consumer c on ct.consumer_id=c.id and c.status=1
join    product_record pr on c.id=pr.consumer_id
and     pr.target_date= :targetDate
join    ques_market_product qmp on pr.QUES_MARKET_PRODUCT_ID=qmp.id
left    join (select  distinct qao.id slim_cig_ans_id,q.consumer_id
            from    question_answers q
            join    product_record pr on q.consumer_id=pr.consumer_id
            and     pr.target_date= :targetDate
            join    question_opts_map qom on q.QUESTION_OPTION_MAP_ID=qom.id and q.question_id=12
            join    ques_activity_opts qao on qom.question_options_id=qao.id and qao.id=25
        )qa on pr.consumer_id=qa.consumer_id
left    join own_market_product_map ompm on qmp.id=ompm.market_product_id
left    join territory_products tp on ompm.own_product_id=tp.product_id
group   by v.teritory_id,v.teritory_name)abd
on v.teritory_id=abd.teritoryId
)abd
FULL JOIN
(select  
        v.teritory_id teritoryId,v.teritory_name teritoryName,
        count(distinct case when qmp.id in (48,49) then pr.consumer_id else null end)matchOutlet2,
        count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) matchSellingOut2,
        count(distinct case when qmp.id in (48,49) and pr.product_stock > 0 then pr.consumer_id else null end) maStockAvaOutlet2,
        round(case when count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) > 0 then (count(distinct case when qmp.id in (48,49) and pr.product_stock > 0 then pr.consumer_id else null end) * 100) /count(distinct case when qmp.id in (48,49) then qa.consumer_id else null end) else 0 end) matchAvailable2
from    (select * from v_teritory_all v where 1=1 and (:wingId is null or v.wing_id = :wingId)) v
join    consumer_teritory ct on ct.teritory_id=v.route_id
join    consumer c on ct.consumer_id=c.id and c.status=1
join    (select * from product_record 
                where route_id in (select distinct route_id from product_record where target_date=to_date(:targetDate,'DD-MON-YY')+ 14)
                and target_date = to_date(:targetDate,'DD-MON-YY') + 14
        ) pr on c.id=pr.consumer_id
join    question_answers qa on pr.consumer_id=qa.consumer_id
join    ques_market_product qmp on pr.QUES_MARKET_PRODUCT_ID=qmp.id
left    join question_opts_map qom on qa.QUESTION_OPTION_MAP_ID=qom.id and qa.question_id=12
left    join ques_activity_opts qao on qom.question_options_id=qao.id and qao.id=25
left    join own_market_product_map ompm on qmp.id=ompm.market_product_id
left    join territory_products tp on ompm.own_product_id=tp.product_id
group   by v.teritory_id,v.teritory_name
)apd
ON abd.teritory_id=apd.teritoryId
)
where  matchAvailable is not null and matchAvailable2 is not null
order  by matchAvailable2
FETCH FIRST 5 ROWS ONLY