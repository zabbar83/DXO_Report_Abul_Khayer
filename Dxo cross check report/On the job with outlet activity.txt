select  
                        to_char(cj.add_date) addDate,
                        ei.emp_name ddxoDxoName,
                        r.role designation,
                        bre.name adxoName,
                        ddxo_dxo_id ddxo,
                        u.teritory_id divTerId,
                        listagg(cj.outlet_name, ', ') within group (order by cj.add_date,ddxo_dxo_id) outletConsName,
                        min(add_time) startTime,
                        max(add_time) endTime,
                        substr(max(add_time) - min(add_time),11,14) executionTime,
                        count(con_out_id) activity
                from    (
                            select  ot.add_date,ot.add_time,
                                    case when dxo_id is null then ddxo_id else dxo_id end ddxo_dxo_id,
                                    ot.adxo_id,ot.outlet_id con_out_id,
                                    c.trade_license_name outlet_name
                            from    OUT_ON_THE_JOB_TRAIN ot
                            join    consumer c on ot.outlet_id=c.id
                            join    consumer_teritory ct on c.id=ct.consumer_id
                            join    v_teritory_all v on ct.teritory_id=v.route_id
                            where   ot.add_date between :fromDate and :toDate
                            and     (:divisionId is null or v.division_id=:divisionId)
                            and     (:teritoryId is null or v.teritory_id=:teritoryId)
                            and     (:routeId is null or v.route_id=:routeId)
                        ) cj
                join    users u on cj.ddxo_dxo_id=u.user_id
                left    join emp_info ei on u.user_id=ei.users_id
                join    users_roles ur on u.user_id=ur.users_user_id
                join    role r on ur.roles_id=r.id
                join    brand_representative bre on cj.adxo_id=bre.br_user_user_id
                group   by cj.add_date,ei.emp_name, r.role,bre.name,ddxo_dxo_id, u.teritory_id
                order   by cj.add_date,u.teritory_id