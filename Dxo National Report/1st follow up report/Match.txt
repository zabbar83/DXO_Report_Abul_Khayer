select  
        productCatId,
        companyName,
        serveyedOutlet,
        firstVisOut,
        sfVisOut,
        volFollowup,
        sum(volFollowup) over (partition by productCatId) allVolFollowup
from
(select  vo.product_cat_id productCatId,vo.company_name companyName,max(sv.serveyedOutlet) serveyedOutlet, sum(firstVisOut) firstVisOut,
        max(sfMat.sfMatVisOut) sfVisOut,
        (sum(firstProdSto) + max(wholeLiftMat))-  max(secMatStock)volFollowup     
from
(select  qmp.product_cat_id,
        case 
             when qmp.product_cat_id=3 and qmp.QMA_COMPANY_ID =3 then 'AKT Match'
             when qmp.product_cat_id=3 and qmp.QMA_COMPANY_ID not in (3) then 'Others Match'
        end company_name,
        count(distinct qa.consumer_id) firstVisOut,
        sum(pr.product_stock) firstProdSto
from    (select * from v_teritory_all v where 1=1 
        and (:wingId is null or v.wing_id = :wingId)
        ) vta
join    consumer_teritory ct on vta.route_id = ct.teritory_id
join    consumer c on ct.consumer_id = c.id and status=1
join    (select distinct consumer_id from question_answers where target_date = to_date(:fromDate,'DD-MON-YY')) qa 
        on c.id = qa.consumer_id
join    (select * from product_record where target_date = to_date(:fromDate,'DD-MON-YY')) pr on qa.consumer_id=pr.consumer_id
join    ques_market_product qmp on pr.ques_market_product_id=qmp.id
and     qmp.product_cat_id in (3)
join    ques_market_analysis_company com on qmp.qma_company_id=com.id
group   by qmp.product_cat_id,qmp.QMA_COMPANY_ID,com.company_name
) vo
JOIN    (select  qmp.product_cat_id,
                    count(distinct qa.consumer_id) serveyedOutlet
            from    (select * from v_teritory_all v where 1=1 
                    and (:wingId is null or v.wing_id = :wingId)
                    ) vta
            join    consumer_teritory ct on vta.route_id = ct.teritory_id
            join    consumer c on ct.consumer_id = c.id and status=1
            join    (select distinct consumer_id from question_answers ) qa 
                    on c.id = qa.consumer_id
            join    (select * from product_record where target_date = to_date(:fromDate,'DD-MON-YY')) pr on qa.consumer_id=pr.consumer_id
            join    ques_market_product qmp on pr.ques_market_product_id=qmp.id
            and     qmp.product_cat_id in (3)
            join    ques_market_analysis_company com on qmp.qma_company_id=com.id
            group   by qmp.product_cat_id
        )sv ON vo.product_cat_id=sv.product_cat_id
LEFT    JOIN (
                           select  vo.product_cat_id,vo.company_name, sum(sfMatVisOut) sfMatVisOut,
                           sum(secMatStock)secMatStock,
                            sum(wholeLiftMat) wholeLiftMat
            from
            (select  qmp.product_cat_id,
                    case when qmp.product_cat_id=3 and qmp.QMA_COMPANY_ID =3 then 'AKT Match'
                         when qmp.product_cat_id=3 and qmp.QMA_COMPANY_ID not in (3) then 'Others Match'
                    end company_name,
                    count(distinct qa.consumer_id) sfMatVisOut,
                    sum(pr.PRODUCT_STOCK) secMatStock,
                    nvl(sum(pr.whole_sale+pr.company_lifting),0) wholeLiftMat
            from    (select * from v_teritory_all v where 1=1 
                    and (:wingId is null or v.wing_id = :wingId)
                    ) vta
            join    consumer_teritory ct on vta.route_id = ct.teritory_id
            join    consumer c on ct.consumer_id = c.id and status=1
            join    (select distinct consumer_id from question_answers where target_date = to_date(:fromDate,'DD-MON-YY')+1) qa 
                    on c.id = qa.consumer_id
            and     qa.consumer_id in(
                        select  distinct qa.consumer_id
                        from    (select * from v_teritory_all v where 1=1 
                                and (:wingId is null or v.wing_id = :wingId)
                                ) vta
                        join    consumer_teritory ct on vta.route_id = ct.teritory_id
                        join    consumer c on ct.consumer_id = c.id and status=1
                        join    (select distinct consumer_id from question_answers where target_date = to_date(:fromDate,'DD-MON-YY')) qa 
                                on c.id = qa.consumer_id
                        join    (select * from product_record where target_date = to_date(:fromDate,'DD-MON-YY')) pr on qa.consumer_id=pr.consumer_id
                        join    ques_market_product qmp on pr.ques_market_product_id=qmp.id
                        and     qmp.product_cat_id =3
                    )
            join    (select * from product_record where target_date = to_date(:fromDate,'DD-MON-YY')+1) pr on qa.consumer_id=pr.consumer_id
            join    ques_market_product qmp on pr.ques_market_product_id=qmp.id
            and     qmp.product_cat_id =3
            join    ques_market_analysis_company com on qmp.qma_company_id=com.id
            group   by qmp.product_cat_id,qmp.QMA_COMPANY_ID,com.company_name
            )vo
            group  by vo.product_cat_id,vo.company_name
) sfMat ON vo.product_cat_id=sfMat.product_cat_id and vo.company_name=sfMat.company_name
group   by vo.product_cat_id,vo.company_name
)
order  by productCatId